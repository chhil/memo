#!/usr/bin/env bash
# =============================================================================
# Markdown → PDF Converter (Pandoc + XeLaTeX + Eisvogel)
# Features:
#   - Mermaid & PlantUML support (via diagram.lua)
#   - M1/Apple Silicon fixes for Mermaid/Puppeteer
#   - Git Metadata injection
# =============================================================================
set -euo pipefail


# 0a. FIX PATHS
# We add $HOME/.local/share/pandoc to the FRONT so it finds our wrapper first
export PATH="$HOME/.local/share/pandoc:/Library/TeX/texbin:/opt/homebrew/bin:$PATH"
# =============================================================================
# 0. ENVIRONMENT CHECKS & CONFIGURATION
# =============================================================================

# --- 1. M1/Apple Silicon Fix for Mermaid ---
if [[ $(uname) == "Darwin" && $(uname -m) == "arm64" ]]; then
    CHROME_PATH="/Applications/Chromium.app/Contents/MacOS/Chromium"
    if [[ -f "$CHROME_PATH" ]]; then
        export PUPPETEER_EXECUTABLE_PATH="$CHROME_PATH"
    else
        echo "⚠️  Warning: M1 Mac detected, but Chromium not found at:"
        echo "   $CHROME_PATH"
        echo "   Mermaid diagrams might fail."
        echo "   Fix: brew install --cask chromium --force"
    fi
fi

# --- 2. Check for Diagram Tools ---
MISSING_TOOLS=0
if ! command -v mmdc &> /dev/null; then
    echo "❌ Error: 'mmdc' (Mermaid CLI) not found."
    echo "   Run: npm install -g @mermaid-js/mermaid-cli"
    MISSING_TOOLS=1
fi
if ! command -v plantuml &> /dev/null; then
    echo "❌ Error: 'plantuml' not found."
    echo "   Run: brew install graphviz plantuml"
    MISSING_TOOLS=1
fi
if (( MISSING_TOOLS )); then exit 1; fi

# --- 3. Download 'diagram.lua' (with corruption check) ---
DIAGRAM_LUA="$HOME/.local/share/pandoc/filters/diagram.lua"
mkdir -p "$(dirname "$DIAGRAM_LUA")"

if [[ -f "$DIAGRAM_LUA" ]]; then
    # If file is < 100 bytes or contains specific non-lua text, it's likely corrupt
    if [[ $(wc -c < "$DIAGRAM_LUA") -lt 100 ]] || head -n 1 "$DIAGRAM_LUA" | grep -qE "<|_extensions"; then
        echo "⚠️  Detected corrupt or outdated diagram.lua. Deleting..."
        rm "$DIAGRAM_LUA"
    fi
fi

if [[ ! -f "$DIAGRAM_LUA" ]]; then
    echo "⬇️  Downloading diagram.lua filter..."
    curl -Ls https://raw.githubusercontent.com/pandoc-ext/diagram/main/_extensions/diagram/diagram.lua -o "$DIAGRAM_LUA"
fi

###############################################################################
# 1 – Defaults & Utilities
###############################################################################
INFO=0; FORCE_TEX=0; GLOSSARY=0; NOMENCL=0
OPEN_PDF=0; YOINK_PDF=0; KEEP=0; CLEAN_ONLY=0
LOG_FILE=""

usage() {
  cat <<EOF
Usage: $(basename "$0") [options] file.md [single|double]
EOF
  exit 1
}

init_git_info() {
  BRANCH=unknown REVISION=unknown TAG=unknown
  if git rev-parse --is-inside-work-tree &>/dev/null; then
    if git rev-parse HEAD &>/dev/null; then
      BRANCH=$(git rev-parse --abbrev-ref HEAD)
      REVISION=$(git rev-parse --short=7 HEAD)
      [[ -n $(git status --porcelain) ]] && REVISION+="*"
      TAG=$(git describe --tags --long 2>/dev/null || git rev-parse --short HEAD)
    fi
  fi
}

quiet_or_log() {
  if (( INFO )); then "$@" 2>&1 | tee -a "$LOG_FILE"; else "$@" >/dev/null 2>&1; fi
}

run_xelatex() {
  local tex=$1
  if (( INFO )); then
    xelatex -interaction=nonstopmode "$tex" 2>&1 | tee -a "$LOG_FILE" || true
  else
    xelatex -interaction=nonstopmode "$tex" >/dev/null 2>&1 || true
  fi
  [[ -f ${tex%.tex}.pdf ]] || { echo "XeLaTeX failed to produce PDF. Run with --info --keep to debug." ; exit 1; }
}

cleanup() {
  if (( KEEP )); then
    (( INFO )) && echo "Keeping intermediates." | tee -a "$LOG_FILE"
    return
  fi
  [[ -f ${BASENAME}_preprocessed.md ]] && rm -f "${BASENAME}_preprocessed.md"
  rm -f "${BASENAME}.tex" "${BASENAME}.aux" "${BASENAME}.log" "${BASENAME}.out" \
        "${BASENAME}.toc" "${BASENAME}.run.xml"
  rm -fr media
}
trap cleanup EXIT

error_handler() {
  local line=$1
  echo "Error at line $line. Run with --info for details." >&2
  exit 1
}
trap 'error_handler $LINENO' ERR

###############################################################################
# 2 – Argument Parsing
###############################################################################
(( $# < 1 )) && usage

M4_PARAMS=()

while (( $# > 0 )); do
  case "$1" in
    -D*) M4_PARAMS+=("$1"); shift ;;
    --info) INFO=1; shift ;;
    --tex) FORCE_TEX=1; shift ;;
    --glossary) GLOSSARY=1; shift ;;
    --nomenclature) NOMENCL=1; shift ;;
    --open) OPEN_PDF=1; shift ;;
    --yoink) YOINK_PDF=1; shift ;;
    --keep) KEEP=1; shift ;;
    --clean) CLEAN_ONLY=1; shift ;;
    -*) echo "Error: Unknown option '$1'" >&2; usage ;;
    *) break ;; 
  esac
done

MD=${1:-}
[[ -z $MD ]] && usage
shift || true

layout=${1:-single}
if [[ "$layout" == "double" ]]; then 
    LAYOUT_OPT="--variable classoption=twocolumn" 
else 
    LAYOUT_OPT="" 
fi

###############################################################################
# 3 – Metadata & Execution
###############################################################################
TS=$(date "+%Y-%m-%d %H:%M") ; D=${TS% *} ; T=${TS#* }
init_git_info

ABS_MD=$(realpath "$MD")
DIR=$(dirname "$ABS_MD")
BASENAME=$(basename "$ABS_MD" .md)
cd "$DIR" || { echo "Cannot cd into $DIR" ; exit 1; }

PDF="${BASENAME}.pdf"
BIB="${BASENAME}.bib"
PREPROCESSED_MD="${BASENAME}_preprocessed.md"
LOG_FILE="${BASENAME}_processing.log"
(( INFO )) && : >"$LOG_FILE"

M4_PARAMS+=(
  "-D__DATE__=$D" "-D__TIME__=$T" "-D__BRANCH__=$BRANCH"
  "-D__REVISION__=$REVISION" "-D__TAG__=$TAG" "-D__FILENAME__=$ABS_MD"
)

PANDOC_TPL_DIR="$HOME/.local/share/pandoc/templates"

if (( CLEAN_ONLY )); then KEEP=0; cleanup; echo "Cleaned."; exit 0; fi

# Preprocess
{ echo 'changequote(«, »)'; echo 'changecom(«@@»)'; cat "$ABS_MD"; } | m4 "${M4_PARAMS[@]}" - > "$PREPROCESSED_MD"

# Check for Bibliography
BIB_OPT=""
if [[ -f "$BIB" ]]; then
    BIB_OPT="--bibliography=$BIB --citeproc"
fi

# Build
pandoc_common=(
  --pdf-engine=xelatex
  --from markdown
  --variable papersize=a4
  --template=custom_eisvogel
  --top-level-division=section
  --listings
  --csl="$PANDOC_TPL_DIR/ieee-with-url.csl"
  --lua-filter="$DIAGRAM_LUA"
  $LAYOUT_OPT
  $BIB_OPT
  -s "$PREPROCESSED_MD"
)

echo "Generating PDF..."
if (( GLOSSARY || NOMENCL || FORCE_TEX )); then
  quiet_or_log pandoc "${pandoc_common[@]}" -o "${BASENAME}.tex"
  run_xelatex "${BASENAME}.tex"
  if (( GLOSSARY || NOMENCL )); then
     (( GLOSSARY )) && quiet_or_log makeglossaries -d . "$BASENAME"
     (( NOMENCL  )) && quiet_or_log makeindex "${BASENAME}.nlo" -s nomencl.ist -o "${BASENAME}.nls"
     run_xelatex "${BASENAME}.tex"
     run_xelatex "${BASENAME}.tex"
  fi
  mv "${BASENAME}.pdf" "$PDF"
else
  quiet_or_log pandoc "${pandoc_common[@]}" -o "$PDF"
fi

echo "PDF saved → $PDF"
[[ $(uname) == Darwin && $OPEN_PDF == 1 ]] && open "$PDF" || :
